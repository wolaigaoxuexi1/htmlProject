# 网页截图扩展 Bug 修复文档（v1.0.2）

本文档记录本次关键缺陷的复现、根因、修复方案与验证结论，便于后续复用与快速排障。

## 版本与环境
- 扩展版本：v1.0.2（修复版）
- 浏览器：Chrome 88+（Chromium 系）
- 操作系统：Windows/macOS/Linux（通用）
- 外部依赖：无
- 设备像素比（DPR）：1.0/2.0/3.0（均考虑）

---

## 缺陷清单与现象

### 缺陷 1：分段拼接出现蓝色横线
- 复现页面：`test-page.html`
- 复现步骤：
  1. 加载扩展，打开 `test-page.html`
  2. 点击“一键截取完整页面”
  3. 生成的长图在分页拼接处出现 1px 蓝色水平线
- 期望结果：拼接无缝，无横线
- 实际结果：分段边界出现蓝色线条（颜色取决于页面顶部固定元素）

### 缺陷 2：其它网页只能截当前可见区域
- 复现页面：部分新闻/博客/文档站点
- 复现步骤：
  1. 打开目标页面
  2. 点击“一键截取完整页面”
  3. 只截取当前视窗，不会自动滚动整页
- 期望结果：自动滚动并拼接全页
- 实际结果：仅得可见区域截图

---

## 根因分析

### 缺陷 1 根因（横线）
1. 页面存在 `position: fixed | sticky` 的元素（如测试页顶部滚动进度条），在每次分段截图时都会被重复捕获，导致拼接后在边界位置形成可见横线。
2. 设备像素比（DPR）与视口高度存在非整数倍换算，若按像素不对齐裁剪/绘制，容易产生 1px 缝隙或重叠，叠加页面背景色即显为有色线。

### 缺陷 2 根因（不滚动）
1. 许多网站使用“内嵌滚动容器”（`overflow: auto/scroll`）作为主滚动区域，而非 `window`/`document`，导致调用 `window.scrollTo` 无效，无法分段滚动。

---

## 修复方案与实现

### 方案概览
- 截图前隐藏固定/粘性元素，截图后恢复（避免重复捕获）
- 自动识别主滚动容器（文档或内嵌容器），对其进行分段滚动
- 基于 DPR/scale 的精确裁剪与绘制，额外 1px 安全重叠消除边缝
- 以页面真实背景色填充 Canvas 底色，避免色差线

### 关键实现点（content/content.js）
1. 隐藏/恢复固定元素
   - 新增：`hideFixedElements()` / `restoreFixedElements()`
   - 截图前：遍历所有元素，遇到 `position: fixed|sticky` 则记录样式后设置 `visibility: hidden; pointer-events: none`
   - 截图后：按记录恢复原状

2. 自动发现主滚动容器
   - 新增：`findMainScrollable()`
   - 逻辑：
     - 优先 `document.scrollingElement`
     - 搜索 `overflowY: auto|scroll` 且 `scrollHeight >> clientHeight` 的最大容器
     - 选择滚动高度最大者作为主容器
   - 新增：`scrollToY(scroller, y)` 统一滚动文档或元素

3. 拼接算法的像素级精确绘制
   - 依据首张截图的宽度与 `viewportWidth` 计算 `scale`
   - 每一段绘制时按 `scale` 计算源区域与目标区域的像素，避免浮点误差
   - 对第二张及之后的分段：源 y 偏移 `+1px`，目标绘制 y 偏移 `-1px`，去除边界线

4. 背景色填充
   - 从 `body/html` 读取 `background-color`，透明则回退为白色 `#fff`
   - `ctx.fillRect(0,0,w,h)` 统一底色

---

## 代码改动摘要（便于回溯）
- 文件：`webpage-screenshot-extension/content/content.js`
  - 新增函数：`hideFixedElements`、`restoreFixedElements`、`findMainScrollable`、`scrollToY`
  - 修改截图主循环：基于主滚动容器滚动，等待资源稳定后分段截图
  - 修改拼接逻辑：按 `scale` 精裁+1px 安全重叠，消除缝隙
  - 新增：截图起止处调用隐藏/恢复固定元素

（popup/background 逻辑保持，未做结构性变更）

---

## 验证用例与结果
1. 本地测试页 `test-page.html`
   - 结果：分段拼接无蓝线；预览正确；复制/下载功能正常
2. 新闻站（内嵌滚动容器）
   - 结果：能自动识别主滚动容器并完整滚动截图
3. 动态图片/懒加载页面
   - 结果：等待加载后整体截图，边界无缝隙

---

## 边界场景与风险
- 页面将内容放在 `iframe` 内：当前不进入子 frame 滚动（后续可支持）
- 极端复杂布局：存在多个等高可滚动容器时，主容器识别可能误选（后续支持手动选择）
- CSS transform 缩放的容器：可能影响像素对齐（仍建议使用安全重叠）

---

## 回滚方案
- 若新策略影响个别站点，可临时回滚至 v1.0.1 的“window 滚动 + 无隐藏 fixed”版本，并记录站点特征以做特例处理。

---

## 后续规划（建议）
1. 提供“手动选择滚动区域”模式（光标拾取主容器）
2. `iframe` 内容截图支持（逐 frame 合成）
3. 大页面内存优化（分块导出或流式拼接）
4. 失败自动重试与更细粒度进度提示

---

## 变更日志（相对 v1.0.1）
- 修复：分段拼接蓝线问题（隐藏 fixed/sticky + 精确拼接）
- 修复：内嵌滚动容器导致只截视窗的问题（自动识别主滚动容器）
- 新增：预览与复制到剪贴板（先前已加入）
- 优化：错误提示、超时保护、用户反馈体验

